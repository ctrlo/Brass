[% IF issue %]
    <div class="row">
        <div class="col-md-6">
            <form method="post">
                <input type="hidden" name="csrf_token" value="[% csrf_token %]">
                <div class="form-group">
                    <label for="title">Title</label>
                    <input type="text" class="form-control" id="title" name="title" value="[% issue.title | html_entity %]">
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea name="description" id="description" class="form-control" rows="6">[% issue.description | html_entity %]</textarea>
                </div>
                <div class="form-group">
                    <label for="project">Project</label>
                    <select class="form-control" id="project" name="project">
                        [% FOREACH project IN projects %]
                            <option value="[% project.id %]" [% IF issue.project == project %]selected[% END %]>[% project.name | html_entity %]</option>
                        [% END %]
                    </select>
                </div>
                <div class="form-group">
                    <label for="priority">Priority</label>
                    <select class="form-control" id="priority" name="priority" [% readonly %]>
                        [% UNLESS issue.priority %]
                            <option value=""></option>
                        [% END %]
                        [% FOREACH priority IN priorities %]
                            <option value="[% priority.id %]" [% IF issue.priority == priority %]selected[% END %]>[% priority.name | html_entity %]</option>
                        [% END %]
                    </select>
                </div>
                [% UNLESS user.has_permission('issue_write_all') OR user.has_permission('issue_write_project') %][% readonly = "readonly" %][% END %]
                <div class="form-group">
                    <label for="type">Type</label>
                    <select class="form-control" id="type" name="type">
                        [% UNLESS issue.type %]
                            <option value=""></option>
                        [% END %]
                        [% FOREACH type IN types %]
                            <option value="[% type.id %]" [% IF issue.type == type %]selected[% END %]>[% type.name | html_entity %]</option>
                        [% END %]
                    </select>
                </div>
                <div class="form-group">
                    <label for="status">Status</label>
                    <select class="form-control" id="status" name="status" [% IF NOT issue.id %][% readonly %][% END %]>
                        [% IF !issue.id AND !issue.status %]
                            <option value="" selected></option>
                        [% END %]
                        [% issue_selected = issue.status.id || 1 %]
                        [% FOREACH status IN statuses %]
                            <option value="[% status.id %]"
                                [% IF issue_selected == status.id %]selected[% END %]
                                [% IF issue.id AND status.id != 1 AND status.id != 3 AND readonly %]disabled[% END %]
                            >[% status.name | html_entity %]</option>
                        [% END %]
                    </select>
                </div>
                <div class="form-group">
                    <label for="security_considerations">Security considerations</label>
                    <input type="text" class="form-control" id="security_considerations" name="security_considerations" value="[% issue.security_considerations | html_entity %]">
                </div>
                <div class="form-group">
                    <label>Tags</label>
                    [% FOREACH tag IN tags %]
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="tag" value="[% tag.id %]"
                                    [% IF issue.has_tag(tag.id) %]checked[% END %]>[% tag.name | html_entity %]
                            </label>
                        </div>
                    [% END %]
                </div>
                <div class="form-group">
                    <label for="status">Author</label>
                    <select class="form-control" id="author" name="author" [% readonly %]>
                        [% UNLESS issue.author %]
                            <option value=""></option>
                        [% END %]
                        [% IF issue.author.deleted %]
                            <option value="[% issue.author.id %]" selected>[% issue.author | html_entity %]</option>
                        [% END %]
                        [% FOREACH u IN users %]
                            <option value="[% u.id %]" [% IF issue.author == u OR (!issue.id AND user.id == u.id) %]selected[% END %]>[% u | html_entity %]</option>
                        [% END %]
                    </select>
                </div>
                <div class="form-group">
                    <label for="status">Owner</label>
                    <select class="form-control" id="owner" name="owner" [% readonly %]>
                        [% UNLESS issue.owner %]
                            <option value=""></option>
                        [% END %]
                        [% IF issue.owner.deleted %]
                            <option value="[% issue.owner.id %]" selected>[% issue.owner | html_entity %]</option>
                        [% END %]
                        [% FOREACH u IN users %]
                            <option value="[% u.id %]" [% IF issue.owner == u OR (!issue.id AND user.id == u.id) %]selected[% END %]>[% u | html_entity %]</option>
                        [% END %]
                    </select>
                </div>
                <div class="form-group">
                    <label for="status">Approver</label>
                    <select class="form-control" id="approver" name="approver" [% readonly %]>
                        [% UNLESS issue.approver %]
                            <option value=""></option>
                        [% END %]
                        [% IF issue.approver.deleted %]
                            <option value="[% issue.approver.id %]" selected>[% issue.approver | html_entity %]</option>
                        [% END %]
                        [% FOREACH u IN users %]
                            <option value="[% u.id %]" [% IF issue.approver == u %]selected[% END %]>[% u | html_entity %]</option>
                        [% END %]
                    </select>
                </div>
                [% UNLESS readonly %]
                    <div class="checkbox">
                        <label>
                            <input name="security" type="checkbox" value="1" [% IF issue.security %]checked[% END %]>
                            This issue is security related
                        </label>
                    </div>
                [% END %]
                [% IF issue.user_can_write(user) %]
                    <button type="submit" name="save" value="save" class="btn btn-default">Save</button>
                [% END %]
            </form>
        </div>
        [% IF issue.id %]
            <div class="col-md-6">
                <form method="post">
                    <input type="hidden" name="csrf_token" value="[% csrf_token %]">
                    <div class="form-group">
                        <label for="comment">Statuses</label>
                        [% FOR status IN issue.status_history %]
                        <div class="well well-sm">
                            <strong>
                                [% status %]
                            </strong><br />[% comment.text_html_links %]
                            By [% status.user | html_entity %] ([% status.datetime %])
                        </div>
                        [% END %]
                    </div>
                    [% IF issue.priority_history.size %]
                        <div class="form-group">
                            <label for="comment">Priority history</label>
                            [% FOR priority IN issue.priority_history %]
                            <div class="well well-sm">
                                <strong>
                                    [% priority %]
                                </strong>
                                By [% priority.user | html_entity %] ([% priority.datetime %])
                            </div>
                            [% END %]
                        </div>
                    [% END %]
                    <div class="form-group">
                        <label for="attachments">Attachments</label>
                        [% FOR file IN issue.files %]
                        <div class="well well-sm">
                            <strong>
                                [% file.datetime %]
                            </strong><br />
                            <a href="/file/[% file.id %]">[% file.name | html_entity %]</a>
                        </div>
                        [% END %]
                    </div>
                    <div class="form-group">
                        <a href="" data-toggle="modal" data-target="#modal_attach" class="btn btn-default">Attach file...</a>
                    </div>
                    <div class="form-group">
                        <label for="comment">Comments</label>
                        [% FOR comment IN issue.comments %]
                        <div class="well well-sm">
                            <strong>
                                By [% comment.author | html_entity %] ([% comment.datetime %])
                            </strong><br />[% comment.text_html_links %]
                        </div>
                        [% END %]
                        <textarea name="comment" id="comment" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        [% IF issue.id %]
                            <button type="submit" name="comment_add" value="submit" class="btn btn-default">Add comment</button>
                        [% END %]
                    </div>
                </form>
            </div>
        [% END %]
    <div>
[% ELSE %]
    <p>
        [% IF user.has_permission('issue_write') OR user.has_permission('issue_write_all') OR user.has_permission('issue_write_project') %]
            <a href="/issue/0" class="btn btn-default">New issue</a>
        [% END %]
        <a href="" data-toggle="modal" data-target="#modal_filter" class="btn btn-default">Filtering...</a>
    </p>
    <table class="table table-striped">
        <tr>
            <th><a href="?sort=id">ID</a></th>
            <th><a href="?sort=title">Title</a></th>
            <th>Description</th>
            <th>Owner</th>
            <th><a href="?sort=opened">Opened</a></th>
            <th>Project</th>
            <th>Type</th>
            <th>Status</th>
            <th><a href="?sort=priority">Priority</a></th>
        </tr>
        [% FOREACH issue IN issues %]
            <tr>
                <td>[% issue.id %]</td>
                <td><a href="/issue/[% issue.id %]">[% issue.title | html_entity %]</a></td>
                <td>[% issue.description | html_entity %]</td>
                <td style="white-space: nowrap">[% issue.owner | html_entity %]</td>
                <td>[% issue.opened | html_entity %]</td>
                <td>[% issue.project | html_entity %]</td>
                <td>[% issue.type | html_entity %]</td>
                <td>[% issue.status | html_entity %]</td>
                <td>[% issue.priority | html_entity %]</td>
            </tr>
        [% END %]
    </table>
[% END %]

<div class="modal fade" id="modal_filter" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form role="form" method="post">
            <input type="hidden" name="csrf_token" value="[% csrf_token %]">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="modal_permissions-title">Filtering</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="filtering_security">Security</label>
                    <select class="form-control" id="filtering_security" name="filtering_security">
                        <option value="" [% IF filtering.security == "" %]selected[% END %]>&lt;Ignore&gt;</option>
                        <option value="yes" [% IF filtering.security == "yes" %]selected[% END %]>Only security issues</option>
                        <option value="no" [% IF filtering.security == "no" %]selected[% END %]>Only non-security issues</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filtering_project">Project</label>
                    <select class="form-control" id="filtering_project" name="filtering_project">
                        <option value="" [% UNLESS filtering.security %]selected[% END %]>&lt;Ignore&gt;</option>
                        [% FOREACH project IN projects %]
                            <option value="[% project.id %]" [% IF filtering.project == project.id %]selected[% END %]>[% project %]</option>
                        [% END %]
                    </select>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    [% FOREACH status IN statuses %]
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="filtering_status" value="[% status.id %]"
                                    [% IF filtering.status.grep(status.id).size %]checked[% END %]>[% status | html_entity %]
                            </label>
                        </div>
                    [% END %]
                </div>
                <div class="form-group">
                    <label for="filtering_type">Type</label>
                    <select class="form-control" id="filtering_type" name="filtering_type">
                        <option value="" [% UNLESS filtering.type %]selected[% END %]>&lt;Ignore&gt;</option>
                        [% FOREACH type IN types %]
                            <option value="[% type.id %]" [% IF filtering.type == type.id %]selected[% END %]>[% type.name | html_entity %]</option>
                        [% END %]
                    </select>
                </div>
                <div class="form-group">
                    <label for="filtering_owner">Owner</label>
                    <select class="form-control" id="filtering_owner" name="filtering_owner">
                        <option value="" [% UNLESS filtering.owner %]selected[% END %]>&lt;Ignore&gt;</option>
                        [% FOREACH user IN users %]
                            <option value="[% user.id %]" [% IF filtering.owner == user.id %]selected[% END %]>[% user | html_entity %]</option>
                        [% END %]
                    </select>
                </div>
                <div class="form-group">
                    <label>Tags</label>
                    [% FOREACH tag IN tags %]
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="filtering_tag" value="[% tag.id %]"
                                    [% IF filtering.tag.grep(tag.id).size %]checked[% END %]>[% tag.name | html_entity %]
                            </label>
                        </div>
                    [% END %]
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" name="submit_filtering" value="submit" class="btn btn-primary">Update</button>
            </div>
            </form>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!-- Modal -->
<div class="modal fade" id="modal_attach" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form role="form" method="post" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="[% csrf_token %]">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">Add attachment</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newattach">Attach new file</label>
                    <input type="file" id="newattach" name="newattach"></input>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="submit" name="attach" value="attach" class="btn btn-primary">Attach</button>
            </div>
            </form>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

